import { ElectronAPI } from '../preload/preload';
import { MarkdownViewer } from './components/MarkdownViewer';
import { Settings } from './components/Settings';
import './styles/default.css';
import 'highlight.js/styles/github-dark.css';

console.log('ğŸš€ main.ts loaded');

declare global {
  interface Window {
    electronAPI: ElectronAPI;
  }
}

let viewer: MarkdownViewer;
let settings: Settings;
let hasFileLoaded = false;

/**
 * ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ãƒ—ãƒ­ã‚»ã‚¹ã®åˆæœŸåŒ–
 */
async function initializeRenderer(): Promise<void> {
  console.log('ğŸ”§ initializeRenderer called');
  console.log('ğŸ“ Document ready state:', document.readyState);
  // MarkdownViewerã®åˆæœŸåŒ–
  viewer = new MarkdownViewer('markdown-viewer');

  // è¨­å®šç”»é¢ã®åˆæœŸåŒ–
  settings = new Settings('settings');

  // ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‚«ã‚¹ã‚¿ãƒ CSSã‚’èª­ã¿è¾¼ã‚“ã§é©ç”¨
  await loadAndApplyCustomCSS();

  // CSSæ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒªã‚¹ãƒŠãƒ¼
  window.addEventListener('css-updated', handleCSSUpdate);

  // ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒªã‚¹ãƒŠãƒ¼
  window.addEventListener('file-loaded', handleFileLoaded);

  // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ãã‚¤ãƒ™ãƒ³ãƒˆ
  if (window.electronAPI?.onFileOpen) {
    window.electronAPI.onFileOpen(openFileDialog);
  }

  // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã®è¨­å®šç”»é¢ãƒˆã‚°ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆ
  if (window.electronAPI?.onToggleSettings) {
    window.electronAPI.onToggleSettings(toggleSettings);
  }

  // CLIã‹ã‚‰æ¸¡ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ãã‚¤ãƒ™ãƒ³ãƒˆ
  if (window.electronAPI?.onFileOpenFromCLI) {
    window.electronAPI.onFileOpenFromCLI((data) => {
      console.log('ğŸ“‹ Loading file from CLI:', data.filePath);
      hasFileLoaded = true;
      viewer.render(data.content);
    });
  }

  // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã®è¨­å®š
  setupDragAndDrop();

  // å¤–éƒ¨ãƒªãƒ³ã‚¯ã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ©ã®è¨­å®š
  setupExternalLinkHandler();

  // README.mdã‚’èª­ã¿è¾¼ã‚“ã§è¡¨ç¤º
  await loadDefaultReadme();
}

/**
 * ã‚«ã‚¹ã‚¿ãƒ CSSã‚’èª­ã¿è¾¼ã‚“ã§é©ç”¨
 */
async function loadAndApplyCustomCSS(): Promise<void> {
  try {
    const css = await window.electronAPI.getCustomCSS();
    if (css) {
      viewer.applyCustomCSS(css);
    }
    // è¨­å®šç”»é¢ã«ã‚‚CSSã‚’èª­ã¿è¾¼ã‚€
    await settings.loadCSS();
  } catch (error) {
    console.error('Failed to load custom CSS:', error);
  }
}

/**
 * è¨­å®šãƒ‘ãƒãƒ«ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
 */
function toggleSettings(): void {
  const settingsPanel = document.getElementById('settings-panel');
  const viewerContainer = document.getElementById('markdown-viewer');

  if (settingsPanel && viewerContainer) {
    const isVisible = settingsPanel.style.display !== 'none';

    if (isVisible) {
      // è¨­å®šã‚’é–‰ã˜ã‚‹
      settingsPanel.style.display = 'none';
      viewerContainer.style.display = 'block';
    } else {
      // è¨­å®šã‚’é–‹ã
      settingsPanel.style.display = 'block';
      viewerContainer.style.display = 'none';
      // è¨­å®šã‚’é–‹ã„ãŸã¨ãã«æœ€æ–°ã®CSSã‚’èª­ã¿è¾¼ã‚€
      settings.loadCSS();
    }
  }
}

/**
 * CSSæ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‡¦ç†
 */
function handleCSSUpdate(event: Event): void {
  const customEvent = event as CustomEvent;
  const css = customEvent.detail?.css;

  if (css !== undefined) {
    viewer.applyCustomCSS(css);
  }
}

/**
 * ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‡¦ç†
 */
function handleFileLoaded(event: Event): void {
  const customEvent = event as CustomEvent;
  const content = customEvent.detail?.content;

  if (content !== undefined) {
    hasFileLoaded = true;
    try {
      viewer.render(content);
    } catch (error) {
      console.error('Render error:', error);
      viewer.showError('Markdownã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  }
}

/**
 * ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ã
 */
async function openFileDialog(): Promise<void> {
  try {
    const result = await window.electronAPI.selectFile();

    if (!result) {
      return;
    }

    hasFileLoaded = true;

    // file-loadedã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«
    const event = new CustomEvent('file-loaded', {
      detail: {
        filePath: result.filePath,
        content: result.content,
      },
    });
    window.dispatchEvent(event);
  } catch (error) {
    console.error('File loading error:', error);
    viewer.showError('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
}

/**
 * ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®gfm.mdã‚’èª­ã¿è¾¼ã‚“ã§è¡¨ç¤º
 */
async function loadDefaultReadme(): Promise<void> {
  if (hasFileLoaded) {
    return;
  }

  try {
    const response = await fetch('./gfm.md');
    if (response.ok) {
      const content = await response.text();
      viewer.render(content);
    }
  } catch (error) {
    console.error('Failed to load gfm.md:', error);
  }
}

/**
 * å¤–éƒ¨ãƒªãƒ³ã‚¯ã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ©ã‚’è¨­å®š
 */
function setupExternalLinkHandler(): void {
  document.addEventListener('click', (event) => {
    const target = event.target as HTMLElement;
    // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸè¦ç´ ãŒãƒªãƒ³ã‚¯ã¾ãŸã¯ãƒªãƒ³ã‚¯å†…ã®è¦ç´ ã‹ç¢ºèª
    const link = target.closest('a');
    if (link && link.href) {
      // å¤–éƒ¨ãƒªãƒ³ã‚¯ï¼ˆhttp/httpsï¼‰ã®ã¿å‡¦ç†
      if (link.href.startsWith('http://') || link.href.startsWith('https://')) {
        event.preventDefault();
        window.electronAPI.openExternal(link.href);
      }
    }
  });
}

/**
 * ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã®è¨­å®š
 */
function setupDragAndDrop(): void {
  const dropZone = document.body;

  dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    e.stopPropagation();
    dropZone.classList.add('drag-over');
  });

  dropZone.addEventListener('dragleave', (e) => {
    e.preventDefault();
    e.stopPropagation();
    dropZone.classList.remove('drag-over');
  });

  dropZone.addEventListener('drop', async (e) => {
    e.preventDefault();
    e.stopPropagation();
    dropZone.classList.remove('drag-over');

    const files = e.dataTransfer?.files;
    if (!files || files.length === 0) return;

    const file = files[0];

    // Markdownãƒ•ã‚¡ã‚¤ãƒ«ã‹ãƒã‚§ãƒƒã‚¯
    if (!file.name.match(/\.(md|markdown|txt)$/i)) {
      viewer.showError('Markdownãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
      return;
    }

    try {
      const content = await file.text();
      hasFileLoaded = true;

      // file-loadedã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«
      const event = new CustomEvent('file-loaded', {
        detail: {
          filePath: file.name,
          content: content,
        },
      });
      window.dispatchEvent(event);
    } catch (error) {
      console.error('File reading error:', error);
      viewer.showError('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  });
}

// DOMContentLoadedå¾Œã«åˆæœŸåŒ–
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initializeRenderer);
} else {
  initializeRenderer();
}
